<script lang="ts">
	import type { Picture } from '$lib/types/Picture';
	import type { Schedule } from '$lib/types/Schedule';
	import PictureComponent from '../Picture.svelte';
	import { useI18n } from '$lib/i18n';
	import { upperFirst } from '$lib/utils/upperFirst';
	import { addMinutes, isSameDay } from 'date-fns';
	import IconRssFeed from '../icons/IconRssFeed.svelte';
	import IcsExport from './IcsExport.svelte';
	import { getScheduleTimezone, offsetFromUTC } from '$lib/utils/scheduleTimezone';

	export let pictures: Picture[] = [];
	export let schedule: Schedule;
	let className = '';
	export { className as class };
	$: pictureByEventSlug = Object.fromEntries(
		pictures.map((picture) => [picture.schedule?.eventSlug, picture])
	);
	const { t, locale } = useI18n();
</script>

{#if schedule.allowSubscription}
	<div class="flex flex-row">
		<a
			href="/schedule/{schedule._id}/subscribe"
			class="btn btn-gray no-underline text-xl text-center whitespace-nowrap p-2 mt-2"
		>
			ðŸ”” {t('schedule.subscribeCTA')}
		</a>
	</div>
{/if}
{#each schedule.events as event}
	<div
		class="flex flex-row gap-4 tagWidget tagWidget-main w-full items-center {className} {event.hideFromList
			? 'hidden'
			: ''}"
	>
		<div class="flex flex-row">
			{#if pictureByEventSlug[event.slug]}
				<PictureComponent
					picture={pictureByEventSlug[event.slug]}
					class="max-h-[6em] max-w-[6em] object-contain {(event.endsAt &&
						event.endsAt < new Date()) ||
					addMinutes(new Date(event.beginsAt), schedule.pastEventDelay) < new Date()
						? 'opacity-50'
						: ''}"
				/>
			{:else}
				<!-- svelte-ignore a11y-img-redundant-alt -->
				<img
					src="/asset/event-default-picture.png"
					alt="default-event-picture"
					class="max-h-[6em] max-w-[6em] object-contain {(event.endsAt &&
						event.endsAt < new Date()) ||
					addMinutes(new Date(event.beginsAt), schedule.pastEventDelay) < new Date()
						? 'opacity-50'
						: ''}"
				/>
			{/if}

			<div class="p-4 pl-8">
				<h2 class="text-2xl font-bold body-title mb-2 flex flex-row">
					{event.title}
					<a title="Provide rss feed" href="/schedule/{schedule._id}/rss.xml" target="_blank">
						<IconRssFeed />
					</a>
				</h2>
				<p class="text-sm">
					{upperFirst(
						event.beginsAt.toLocaleDateString($locale, {
							weekday: 'long',
							day: 'numeric',
							month: 'long',
							year: 'numeric'
						})
					)}
					{#if event.endsAt && isSameDay(event.endsAt, event.beginsAt)}
						{t('schedule.dateText', {
							beginTime: addMinutes(
								event.beginsAt,
								offsetFromUTC(getScheduleTimezone(schedule))
							).toLocaleTimeString($locale, {
								hour: '2-digit',
								minute: '2-digit'
							}),
							endTime: addMinutes(
								event.endsAt,
								offsetFromUTC(getScheduleTimezone(schedule))
							).toLocaleTimeString($locale, {
								hour: '2-digit',
								minute: '2-digit'
							})
						})}
					{:else if event.endsAt && !isSameDay(event.endsAt, event.beginsAt)}
						{t('schedule.differentDayText', {
							beginDate: addMinutes(
								event.endsAt,
								offsetFromUTC(getScheduleTimezone(schedule))
							).toLocaleTimeString($locale, {
								hour: '2-digit',
								minute: '2-digit'
							}),
							endDate: addMinutes(
								event.endsAt,
								offsetFromUTC(getScheduleTimezone(schedule))
							).toLocaleTimeString($locale, {
								weekday: 'long',
								day: 'numeric',
								month: 'long',
								year: 'numeric',
								hour: '2-digit',
								minute: '2-digit'
							})
						})}
					{:else}
						{t('schedule.uniqueDateText', {
							beginTime: addMinutes(
								event.beginsAt,
								offsetFromUTC(getScheduleTimezone(schedule))
							).toLocaleTimeString($locale, {
								hour: '2-digit',
								minute: '2-digit'
							})
						})}
					{/if}
					{#if event.location?.name}
						- <a href={event.location.link} target="_blank" class="body-hyperlink"
							>{event.location.name}</a
						>
					{/if}
					{#if event.unavailabity?.isUnavailable}
						<span class="font-bold">[{event.unavailabity.label}]</span>
					{/if}
				</p>
				<div class="flex flex-row gap-4">
					{#if event.url}
						<a
							href={event.url}
							target="_blank"
							class="btn cartPreview-secondaryCTA text-xl text-center whitespace-nowrap p-1 mt-2"
						>
							{t('schedule.moreInfo')}
						</a>
					{/if}
					{#if event.rsvp?.target && event.endsAt && event.endsAt > new Date()}
						<a
							href="/schedule/{schedule._id}/rsvp/{event.slug}"
							target="_blank"
							class="btn cartPreview-secondaryCTA text-xl text-center whitespace-nowrap p-1 mt-2"
						>
							RSVP
						</a>
					{/if}
					<IcsExport {event} pastEventDelay={schedule.pastEventDelay} class="mt-4" />
				</div>
			</div>
		</div>
	</div>
{/each}
